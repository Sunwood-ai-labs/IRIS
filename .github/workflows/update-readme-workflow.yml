name: ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEæ›´æ–°

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/requirements.txt

      - name: READMEã®æ›´æ–°
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          YOUR_PERSONAL_ACCESS_TOKEN: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN }}
          YOUR_PERSONAL_ACCESS_TOKEN_IRIS: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
        run: python .github/scripts/update_readme.py

      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"

      - name: å¤‰æ›´ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
        id: check_changes
        run: |
          git add README.md
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ğŸ“ ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEæ›´æ–°"
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          branch_name="update-readme-${{ github.run_id }}"
          git checkout -b $branch_name
          git push -u origin $branch_name
          pr_url=$(gh pr create --title "ğŸ“ ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEè‡ªå‹•æ›´æ–°" --body "ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã«åŸºã¥ã„ã¦READMEã‚’è‡ªå‹•æ›´æ–°ã—ãŸã‚‚ã®ã§ã™ã€‚å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚" --base main --head $branch_name)
          echo "PR_URL=$pr_url" >> $GITHUB_ENV

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•ãƒãƒ¼ã‚¸
        if: steps.check_changes.outputs.changes == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$PR_URL" ]; then
            pr_number=$(echo $PR_URL | awk -F'/' '{print $NF}')
            gh pr merge $pr_number --auto --squash --delete-branch
          else
            echo "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¸ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
