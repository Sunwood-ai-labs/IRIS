name: ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEæ›´æ–°

on:
  release:
    types: [published]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: Pythonã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/requirements.txt

      - name: READMEã®æ›´æ–°
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          YOUR_PERSONAL_ACCESS_TOKEN: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN }}
          YOUR_PERSONAL_ACCESS_TOKEN_IRIS: ${{ secrets.YOUR_PERSONAL_ACCESS_TOKEN_IRIS }}
        run: python .github/scripts/update_readme.py

      - name: Gitãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: å¤‰æ›´ã®ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆ
        id: check_changes
        run: |
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            git commit -m "ğŸ“ ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEæ›´æ–°"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ
        if: steps.check_changes.outputs.changes_detected == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: ğŸ“ ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEæ›´æ–°
          title: ğŸ“ ãƒªãƒªãƒ¼ã‚¹å¾Œã®READMEè‡ªå‹•æ›´æ–°
          body: |
            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã€æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã«åŸºã¥ã„ã¦READMEã‚’è‡ªå‹•æ›´æ–°ã—ãŸã‚‚ã®ã§ã™ã€‚
            å†…å®¹ã‚’ç¢ºèªã—ã€å•é¡ŒãŒãªã‘ã‚Œã°ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚
          branch: update-readme-${{ github.run_id }}
          base: main
          labels: documentation, automated pr

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•ãƒãƒ¼ã‚¸
        if: steps.create_pr.outputs.pull-request-number
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.create_pr.outputs.pull-request-number }}
        run: |
          gh pr merge --auto --merge "$PR_NUMBER"
